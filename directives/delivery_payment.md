# Директива: Доставка и Оплата

## Цель
Создать систему расчёта доставки, генерации PDF счётов, обработки оплаты (fake) и генерации трек-номеров.

## Компоненты

### 1. Delivery Calculator (`execution/delivery_calculator.py`)
**Назначение**: Расчёт стоимости доставки на основе города и веса

**Функционал**:
- `calculate(city: str, weight: float, dimensions: dict) -> dict`
- Правила расчёта:
  - Москва: 500₽ (до 5кг), 800₽ (5-10кг), 1200₽ (>10кг)
  - Санкт-Петербург: 600₽ (до 5кг), 900₽ (5-10кг), 1400₽ (>10кг)
  - Другие города: 1000₽ (до 5кг), 1500₽ (5-10кг), 2000₽ (>10кг)
- Расчёт веса на основе товаров в заказе
- Возврат структуры: `{city, weight, cost, estimated_days, carrier}`

**Переменные окружения**:
- `DELIVERY_RULES_JSON` (опционально) - JSON конфигурация правил

**Интеграция**:
- Автоматический расчёт при создании заказа
- Сохранение `delivery_cost` в `orders.delivery_cost`

### 2. Invoice Generator (`execution/invoice_generator.py`)
**Назначение**: Генерация PDF счётов в стиле 1С

**Функционал**:
- Генерация PDF счёта на оплату
- Формат 1С-стиль: шапка, номер счёта (INV-YYYY-NNNN), таблица товаров, итоги
- Сохранение в `.tmp/invoices/{order_id}.pdf`
- Обновление статуса на `invoice_created`

**Переменные окружения**:
- `COMPANY_NAME` - название компании
- `COMPANY_INN` - ИНН
- `COMPANY_KPP` - КПП
- `COMPANY_ADDRESS` - адрес компании

### 3. Payment Processor (`execution/payment_processor.py`)
**Назначение**: Обработка оплаты (fake система)

**Функционал**:
- `process_payment(order_id, card_data) -> dict`
- Валидация данных карты (формат)
- Симуляция оплаты (всегда успешная, задержка 1-2 сек)
- Генерация `transaction_id`
- Обновление статуса на `paid`

**⚠️ ВАЖНО**: Это fake система, не использовать реальные платёжные данные!

### 4. Tracking Generator (`execution/tracking_generator.py`)
**Назначение**: Генерация трек-номеров

**Функционал**:
- Генерация трек-номера: `TRACK-{YYYYMMDD}-{6 random digits}`
- Сохранение в `orders.tracking_number`
- Обновление статуса на `shipped`
- Обновление `shipped_at`

## Формат данных

### Результат расчёта доставки
```json
{
  "city": "Москва",
  "weight": 3.5,
  "cost": 500,
  "estimated_days": 1,
  "carrier": "local"
}
```

### Данные карты (fake)
```json
{
  "card_number": "4111111111111111",
  "cvv": "123",
  "expiry": "12/25",
  "holder_name": "IVAN IVANOV"
}
```

## Обработка ошибок

- **Расчёт доставки**: Fallback на максимальную стоимость при ошибке
- **Генерация PDF**: Retry, логирование ошибок
- **Оплата**: Валидация данных, обработка ошибок
- **Трек-номер**: Простая генерация, без внешних зависимостей

## Логирование

Все операции логируются:
- Расчёт доставки (город, вес, стоимость)
- Генерация счёта (номер счёта, путь к PDF)
- Оплата (order_id, transaction_id, без CVV!)
- Генерация трек-номера (номер, order_id)

## Тестирование

### Ручное тестирование
1. Расчёт доставки для разных городов
2. Генерация PDF счёта
3. Симуляция оплаты
4. Генерация трек-номера

## Критерии готовности

- ✅ Расчёт доставки работает для разных городов
- ✅ PDF счёты генерируются в стиле 1С
- ✅ Оплата обрабатывается (fake)
- ✅ Трек-номера генерируются после оплаты
- ✅ Все статусы обновляются корректно

## Следующие шаги

После реализации доставки и оплаты перейти к Этапу 6: Экспорт в 1С.
