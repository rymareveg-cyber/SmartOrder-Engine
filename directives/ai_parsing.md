# Директива: AI-парсинг заказов

## Цель
Создать AI-модуль на основе GPT-4 для парсинга неструктурированных заказов, извлечения товаров из каталога 1С, валидации и формирования структурированных заказов.

## Входные данные
- Сообщения из Redis Queue (от Telegram, Яндекс.Почты, Яндекс.Форм)
- Каталог товаров из PostgreSQL (таблица `products`)

## Выходные данные
Структурированные заказы с извлечёнными товарами, контактами клиента и статусом валидации.

## Формат входных сообщений

### Telegram
```json
{
  "channel": "telegram",
  "user_id": "123456789",
  "chat_id": "123456789",
  "message": "Хочу 2 варочные панели по 120 тысяч",
  "timestamp": "2026-02-13T10:30:00Z",
  "message_id": 12345
}
```

### Яндекс.Почта
```json
{
  "channel": "yandex_mail",
  "email": "sender@example.com",
  "subject": "Заказ товаров",
  "body": "Нужно 2 варочные панели, доставка в Москву",
  "attachments": [],
  "timestamp": "2026-02-13T10:30:00Z"
}
```

### Яндекс.Формы
```json
{
  "channel": "yandex_forms",
  "form_id": "form_123",
  "form_name": "Заказ товаров",
  "submission_id": "sub_456",
  "data": {
    "name": "Иван Иванов",
    "phone": "+79001234567",
    "products": "2 варочные панели"
  },
  "timestamp": "2026-02-13T10:30:00Z"
}
```

## Формат выходных данных

### Успешный парсинг
```json
{
  "order_id": "temp-123",
  "status": "validated",
  "products": [
    {
      "articul": "ФР-00000044",
      "name": "Варочная панель",
      "quantity": 2,
      "price_at_order": 122334,
      "available": true,
      "stock": 1,
      "validated": true
    }
  ],
  "customer": {
    "name": "Иван Иванов",
    "phone": "+79001234567",
    "address": "Москва, ул. Ленина, 1"
  },
  "missing_data": [],
  "unfound_products": []
}
```

### Требуется уточнение
```json
{
  "order_id": "temp-123",
  "status": "needs_clarification",
  "products": [
    {
      "articul": "ФР-00000044",
      "name": "Варочная панель",
      "quantity": 2,
      "price_at_order": 122334,
      "available": true,
      "stock": 1,
      "validated": true
    }
  ],
  "customer": {
    "name": null,
    "phone": null,
    "address": "Москва"
  },
  "missing_data": ["name", "phone", "full_address"],
  "clarification_questions": [
    "Укажите, пожалуйста, ваше ФИО",
    "Укажите, пожалуйста, ваш телефон",
    "Укажите полный адрес доставки в Москве"
  ]
}
```

## Инструменты выполнения

### 1. AI Order Parser (`execution/ai_order_parser.py`)
**Назначение**: Основной модуль AI-парсинга заказов

**Функционал**:
1. **Интеграция с OpenAI API**:
   - Использование модели `gpt-4.1-mini`
   - BASE URL: `https://api.proxyapi.ru/openai/v1`
   - Retry логика при ошибках API
   - Логирование всех запросов

2. **Загрузка каталога**:
   - Получение всех товаров из PostgreSQL
   - Формирование JSON для промпта
   - Кэширование каталога (обновление каждые 5 минут)

3. **Формирование промпта**:
   - Использование шаблонов из `prompt_templates.py`
   - Подстановка каталога и сообщения клиента
   - Указание формата ответа (JSON)

4. **Парсинг ответа GPT**:
   - Валидация JSON структуры
   - Обработка ошибок парсинга
   - Fallback на regex парсинг при недоступности GPT

5. **Валидация данных**:
   - Проверка существования товаров в каталоге
   - Проверка остатков (stock >= quantity)
   - Валидация контактов (формат телефона, адреса)

6. **Формирование структурированного заказа**:
   - Объединение данных из GPT и валидации
   - Определение статуса (validated / needs_clarification)
   - Генерация уточняющих вопросов

**Переменные окружения**:
- `OPENAI_API_KEY` - API ключ OpenAI
- `OPENAI_MODEL=gpt-4.1-mini` - модель для использования
- `OPENAI_BASE_URL=https://api.proxyapi.ru/openai/v1` - BASE URL для API
- `DATABASE_URL` - строка подключения к PostgreSQL
- `REDIS_URL` - строка подключения к Redis

**Запуск**:
```bash
python execution/ai_order_parser.py
```

### 2. Prompt Templates (`execution/prompt_templates.py`)
**Назначение**: Шаблоны промптов для GPT

**Шаблоны**:
- `get_parsing_prompt(catalog_json, customer_message)` - основной промпт для парсинга
- `get_clarification_questions_prompt(missing_data)` - генерация уточняющих вопросов
- `get_confirmation_prompt(order_data)` - подтверждение заказа

### 3. Catalog Matcher (`execution/catalog_matcher.py`)
**Назначение**: Сопоставление товаров из сообщения с каталогом

**Функционал**:
- Fuzzy matching (rapidfuzz)
- Поиск по артикулу (точное совпадение)
- Поиск по названию (частичное совпадение)
- Ранжирование результатов по релевантности

### 4. Fallback Parser (`execution/ai_order_parser.py`)
**Назначение**: Парсинг на основе правил (regex) при недоступности GPT

**Функционал**:
- Извлечение артикулов (формат ФР-XXXXXXXX)
- Извлечение количеств (числа перед названиями товаров)
- Извлечение контактов (телефоны, адреса)

## Обработка ошибок

### Ошибки OpenAI API
- **Rate limit**: Retry с экспоненциальной задержкой (1s, 2s, 4s, max 30s)
- **Timeout**: Retry до 3 попыток
- **Invalid API key**: Логирование и остановка обработки
- **Service unavailable**: Fallback на regex парсинг

### Ошибки парсинга
- **Невалидный JSON**: Попытка исправления, fallback на regex
- **Товар не найден**: Добавление в `unfound_products`, статус `needs_clarification`
- **Недостаточный остаток**: Предложение доступного количества

### Ошибки валидации
- **Невалидный телефон**: Запрос уточнения
- **Неполный адрес**: Запрос полного адреса
- **Отсутствие ФИО**: Запрос ФИО

## Крайние случаи

### Неструктурированное сообщение
- **Пример**: "хочу что-то купить"
- **Обработка**: GPT попытается найти товары, если не найдёт - запрос уточнения

### Множественные товары
- **Пример**: "2 панели и 1 шуба"
- **Обработка**: GPT извлечёт все товары и количества

### Неверный артикул
- **Пример**: "ФР-99999999" (не существует)
- **Обработка**: Добавление в `unfound_products`, запрос уточнения

### Недостаточный остаток
- **Пример**: Запрос 5 штук, в наличии 2
- **Обработка**: Предложение доступного количества, статус `needs_clarification`

## Примеры работы

### Пример 1: Успешный парсинг
**Входное сообщение**: "Хочу 2 варочные панели по 120 тысяч, доставка в Москву"

**Ответ GPT**:
```json
{
  "products": [{"articul": "ФР-00000044", "name": "Варочная панель", "quantity": 2}],
  "customer": {"address": "Москва"},
  "missing_data": ["name", "phone", "full_address"]
}
```

**Результат валидации**: Статус `needs_clarification`, требуется уточнение контактов

### Пример 2: Товар не найден
**Входное сообщение**: "Нужен iPhone 15"

**Ответ GPT**:
```json
{
  "products": [],
  "unfound_products": ["iPhone 15"],
  "missing_data": ["name", "phone", "address"]
}
```

**Результат**: Статус `needs_clarification`, запрос уточнения товара

## Логирование

Все события логируются в файл `logs/ai_order_parser.log`:
- Запросы к GPT (промпт, ответ)
- Результаты валидации
- Ошибки парсинга
- Метрики: количество обработанных заказов, точность парсинга

**Формат логов**: Структурированное логирование с timestamp, level, message

## Тестирование

### Ручное тестирование
1. Отправить тестовое сообщение в очередь
2. Проверить обработку AI-парсером
3. Проверить результат валидации
4. Проверить уточняющие вопросы (если требуется)

### Тестирование edge cases
1. Неструктурированные сообщения
2. Товары не из каталога
3. Недостаточные остатки
4. Неполные контакты

## Критерии готовности

- ✅ AI-парсер извлекает товары из сообщений
- ✅ Сопоставление с каталогом работает (fuzzy matching)
- ✅ Валидация остатков и данных клиента
- ✅ Генерация уточняющих вопросов
- ✅ Обработка ошибок и fallback механизмы
- ✅ Интеграция с OpenAI API (gpt-4.1-mini)
- ✅ Логирование всех запросов

## Следующие шаги

После реализации AI-парсера перейти к Этапу 4: CRM Postgres для сохранения структурированных заказов.
