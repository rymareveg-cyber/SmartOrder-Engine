# Директива: Парсинг заказов из Яндекс.Почты

## Цель
Мониторить входящие письма в Яндекс.Почте, извлекать заказы из текста писем и отправлять их в Redis Queue для дальнейшей обработки AI-парсером.

## Входные данные
- IMAP подключение к Яндекс.Почте
- Входящие письма в папке INBOX (или указанной в конфигурации)
- Письма могут содержать:
  - Текстовое описание заказа в теле письма
  - Вложения (Excel, Word, PDF с заказами)

## Выходные данные
Структурированные сообщения в Redis Queue (`orders:queue`) в формате:
```json
{
  "channel": "yandex_mail",
  "email": "sender@example.com",
  "subject": "Заказ товаров",
  "body": "Текст письма с заказом...",
  "attachments": [
    {
      "filename": "order.xlsx",
      "content": "base64_encoded_content"
    }
  ],
  "timestamp": "2026-02-13T10:30:00Z"
}
```

## Формат писем с заказами

### Типичные сценарии

#### Сценарий 1: Простое текстовое письмо
```
От: ivan@example.com
Тема: Заказ товаров

Здравствуйте!
Хочу заказать:
- 2 варочные панели (артикул ФР-00000044)
- 1 шуба норковая (артикул ФР-00000389)

Доставка в Москву, ул. Ленина, д. 10
Телефон: +79001234567
```

#### Сценарий 2: Письмо с вложением
```
От: manager@company.com
Тема: Заказ на поставку

Добрый день!
Отправляю файл с заказом во вложении.

С уважением,
Иван Иванов
```

**Вложение**: `order_2026-02-13.xlsx` с таблицей товаров

#### Сценарий 3: HTML письмо
```html
<html>
<body>
  <h2>Заказ товаров</h2>
  <p>Товар: Варочная панель</p>
  <p>Количество: 2 шт</p>
  <p>Цена: 120000 руб</p>
</body>
</html>
```

## Инструмент выполнения

### execution/yandex_mail_parser.py

**Назначение**: Мониторинг и парсинг входящих писем из Яндекс.Почты

**Функционал**:
1. **Подключение к IMAP**:
   - Использование `imaplib.IMAP4_SSL` для безопасного подключения
   - Автоматический reconnect при ошибках подключения
   - Таймауты для операций (30 секунд)

2. **Мониторинг писем**:
   - Polling каждые 2 минуты (настраиваемо)
   - Поиск непрочитанных писем (`UNSEEN`)
   - Фильтрация по дате (только новые письма с момента последнего запуска)

3. **Фильтрация писем**:
   - По отправителю: whitelist email адресов (опционально, через переменную окружения)
   - По теме: ключевые слова "заказ", "order", "товар" (опционально)
   - По папке: настраиваемая папка (по умолчанию INBOX)

4. **Парсинг письма**:
   - Извлечение plain text из письма
   - Fallback на HTML парсинг (удаление тегов, извлечение текста)
   - Декодирование различных кодировок (UTF-8, Windows-1251, KOI8-R)
   - Обработка multipart писем

5. **Извлечение вложений**:
   - Поддержка форматов: .xlsx, .xls, .doc, .docx, .pdf, .txt
   - Максимальный размер вложения: 10MB
   - Кодирование в base64 для передачи в очередь
   - Сохранение оригинального имени файла

6. **Отправка в очередь**:
   - Формирование JSON сообщения
   - Отправка в Redis Queue (`orders:queue`)
   - Retry логика при ошибках Redis

7. **Помечение писем**:
   - Помечение как прочитанных (`SEEN`) после успешной обработки
   - Перемещение в папку `Processed` (опционально)

**Переменные окружения**:
- `YANDEX_MAIL_IMAP_HOST=imap.yandex.ru` - IMAP сервер
- `YANDEX_MAIL_EMAIL` - email для мониторинга
- `YANDEX_MAIL_PASSWORD` - пароль или app password
- `YANDEX_MAIL_FOLDER=INBOX` - папка для мониторинга
- `YANDEX_MAIL_POLL_INTERVAL=120` - интервал опроса в секундах (по умолчанию 120)
- `YANDEX_MAIL_WHITELIST` - список разрешённых отправителей (через запятую, опционально)
- `YANDEX_MAIL_SUBJECT_KEYWORDS` - ключевые слова в теме (через запятую, опционально)
- `REDIS_URL` - строка подключения к Redis

**Запуск**:
```bash
python execution/yandex_mail_parser.py
```

## Обработка ошибок

### Ошибки подключения IMAP
- **Ошибка аутентификации**: Логирование и остановка (требует проверки пароля)
- **Таймаут подключения**: Retry с экспоненциальной задержкой (5s, 10s, 20s, max 60s)
- **Сетевые ошибки**: Автоматический reconnect с задержкой

### Ошибки парсинга письма
- **Неизвестная кодировка**: Fallback на UTF-8, логирование предупреждения
- **Повреждённое письмо**: Пропуск письма, логирование ошибки
- **Большое вложение (>10MB)**: Пропуск вложения, обработка только текста письма

### Ошибки Redis
- **Ошибка подключения**: Retry с задержкой (1s, 2s, 4s, max 30s)
- **Ошибка отправки**: Логирование и повторная попытка (до 3 раз)

## Крайние случаи

### Пустые письма
- **Письмо без текста и вложений**: Пропуск, логирование предупреждения
- **Письмо только с HTML без текста**: Парсинг HTML, извлечение текста

### Спам
- **Фильтрация по отправителю**: Использование whitelist (если настроен)
- **Фильтрация по теме**: Проверка ключевых слов (если настроены)
- **Письма без ключевых слов**: Обработка всех писем (если фильтры не настроены)

### Форматирование
- **Множественные кодировки**: Автоматическое определение и декодирование
- **HTML с изображениями**: Извлечение только текста, игнорирование изображений
- **Таблицы в HTML**: Сохранение структуры таблиц в текстовом виде

### Вложения
- **Неподдерживаемый формат**: Логирование предупреждения, пропуск вложения
- **Повреждённое вложение**: Пропуск вложения, обработка только текста
- **Множественные вложения**: Обработка всех поддерживаемых вложений

## Примеры успешного парсинга

### Пример 1: Простое текстовое письмо
**Входное письмо**:
```
От: client@example.com
Тема: Заказ

Нужно 2 варочные панели, доставка в Москву.
```

**Выходное сообщение в очереди**:
```json
{
  "channel": "yandex_mail",
  "email": "client@example.com",
  "subject": "Заказ",
  "body": "Нужно 2 варочные панели, доставка в Москву.",
  "attachments": [],
  "timestamp": "2026-02-13T10:30:00Z"
}
```

### Пример 2: Письмо с вложением
**Входное письмо**:
```
От: manager@company.com
Тема: Заказ на поставку
Вложение: order.xlsx (5KB)
```

**Выходное сообщение в очереди**:
```json
{
  "channel": "yandex_mail",
  "email": "manager@company.com",
  "subject": "Заказ на поставку",
  "body": "",
  "attachments": [
    {
      "filename": "order.xlsx",
      "content": "UEsDBBQAAAAI..."
    }
  ],
  "timestamp": "2026-02-13T10:30:00Z"
}
```

## Логирование

Все события логируются в файл `logs/yandex_mail_parser.log`:
- Успешная обработка письма (email, subject, количество вложений)
- Ошибки подключения и парсинга
- Пропущенные письма (спам, пустые)
- Метрики: количество обработанных писем за сессию

**Формат логов**: Структурированное логирование с timestamp, level, message

## Тестирование

### Ручное тестирование
1. Отправить тестовое письмо на мониторируемый email
2. Проверить обработку через 2 минуты
3. Проверить сообщение в Redis Queue
4. Проверить, что письмо помечено как прочитанное

### Тестирование вложений
1. Отправить письмо с вложением .xlsx
2. Проверить извлечение и кодирование вложения
3. Проверить обработку больших вложений (>10MB)

### Тестирование ошибок
1. Отключить интернет → проверить reconnect логику
2. Неправильный пароль → проверить обработку ошибки аутентификации
3. Повреждённое письмо → проверить graceful handling

## Критерии готовности

- ✅ Успешное подключение к IMAP серверу Яндекс.Почты
- ✅ Мониторинг входящих писем каждые 2 минуты
- ✅ Парсинг текста письма (plain text + HTML fallback)
- ✅ Извлечение вложений (до 10MB)
- ✅ Отправка сообщений в Redis Queue
- ✅ Помечение писем как прочитанных
- ✅ Обработка ошибок с reconnect логикой
- ✅ Фильтрация по отправителю/теме (опционально)
- ✅ Логирование всех событий

## Следующие шаги

После реализации IMAP парсера перейти к Этапу 2.3: Яндекс.Формы Webhook.
