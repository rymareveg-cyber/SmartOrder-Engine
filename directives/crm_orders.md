# Директива: CRM управление заказами

## Цель
Создать систему управления заказами в PostgreSQL с полным CRUD операциями и статусами жизненного цикла заказа.

## Входные данные
- Структурированные заказы от AI-парсера (OrderResult)
- Данные клиента (ФИО, телефон, адрес)
- Товары заказа (артикул, название, количество, цена)

## Выходные данные
- Сохранённые заказы в БД с уникальными номерами
- Обновлённые статусы заказов
- Списки заказов с фильтрацией и пагинацией

## Структура БД

### Таблица orders
- `id` (UUID, primary key) - уникальный идентификатор
- `order_number` (VARCHAR, unique) - номер заказа (ORD-YYYY-NNNN)
- `status` (VARCHAR) - статус заказа
- `channel` (VARCHAR) - канал поступления (telegram, yandex_mail, yandex_forms)
- `customer_name` (VARCHAR) - ФИО клиента
- `customer_phone` (VARCHAR) - телефон клиента
- `customer_address` (TEXT) - адрес доставки
- `total_amount` (DECIMAL) - общая сумма заказа
- `delivery_cost` (DECIMAL) - стоимость доставки
- `created_at` (TIMESTAMP) - время создания
- `updated_at` (TIMESTAMP) - время обновления
- `paid_at` (TIMESTAMP, nullable) - время оплаты
- `shipped_at` (TIMESTAMP, nullable) - время отправки

### Таблица order_items
- `id` (UUID, primary key) - уникальный идентификатор
- `order_id` (UUID, foreign key) - ссылка на заказ
- `product_articul` (VARCHAR, foreign key) - артикул товара
- `product_name` (VARCHAR) - название товара (snapshot)
- `quantity` (INTEGER) - количество
- `price_at_order` (DECIMAL) - цена на момент заказа
- `total` (DECIMAL) - общая стоимость позиции

## Статусы заказа

1. **new** - новый заказ (только создан)
2. **validated** - проверен AI-парсером, данные валидны
3. **invoice_created** - счёт сгенерирован и отправлен клиенту
4. **paid** - оплачен клиентом
5. **shipped** - отправлен (трек-номер создан)
6. **cancelled** - отменён

## Инструменты выполнения

### 1. CRM Service (`execution/crm_service.py`)
**Назначение**: Бизнес-логика работы с заказами

**Функционал**:
- `create_order(data)` - создание заказа с товарами
- `get_order(order_id)` - получение заказа по ID
- `update_order_status(order_id, status)` - обновление статуса
- `list_orders(filters)` - список заказов с фильтрацией
- `add_order_item(order_id, item_data)` - добавление товара в заказ
- Автоматическая генерация `order_number` (ORD-YYYY-NNNN)
- Транзакции для атомарности операций

**Переменные окружения**:
- `DATABASE_URL` - строка подключения к PostgreSQL

**Запуск**:
Используется как библиотека, не запускается напрямую.

### 2. API Orders (`execution/api_orders.py`)
**Назначение**: FastAPI endpoints для работы с заказами

**Endpoints**:
- `POST /api/orders` - создание заказа
- `GET /api/orders/{order_id}` - получение заказа
- `PATCH /api/orders/{order_id}/status` - обновление статуса
- `GET /api/orders` - список заказов (фильтры, пагинация)
- `GET /api/orders/{order_id}/items` - товары заказа

**Переменные окружения**:
- `DATABASE_URL` - строка подключения к PostgreSQL
- `API_PORT` - порт для API (по умолчанию 8025)

**Запуск**:
```bash
python execution/api_orders.py
```

## Формат данных

### Создание заказа
```json
{
  "channel": "telegram",
  "customer_name": "Иван Иванов",
  "customer_phone": "+79001234567",
  "customer_address": "Москва, ул. Ленина, д. 1",
  "items": [
    {
      "product_articul": "ФР-00000044",
      "product_name": "Варочная панель",
      "quantity": 2,
      "price_at_order": 122334
    }
  ],
  "delivery_cost": 500
}
```

### Ответ при создании
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "order_number": "ORD-2026-0001",
  "status": "new",
  "channel": "telegram",
  "customer_name": "Иван Иванов",
  "customer_phone": "+79001234567",
  "customer_address": "Москва, ул. Ленина, д. 1",
  "total_amount": 245168,
  "delivery_cost": 500,
  "created_at": "2026-02-13T10:30:00Z",
  "items": [...]
}
```

## Обработка ошибок

### Ошибки создания заказа
- **Невалидные данные**: Возврат 400 Bad Request с описанием ошибки
- **Товар не найден**: Проверка существования товара в каталоге
- **Ошибка БД**: Rollback транзакции, возврат 500 Internal Server Error

### Ошибки обновления статуса
- **Заказ не найден**: Возврат 404 Not Found
- **Недопустимый переход статуса**: Возврат 400 Bad Request
- **Ошибка БД**: Логирование и возврат 500

## Валидация

### При создании заказа
- Проверка обязательных полей (customer_name, customer_phone, items)
- Проверка количества товаров (quantity > 0)
- Проверка цен (price_at_order > 0)
- Проверка существования товаров в каталоге

### При обновлении статуса
- Проверка допустимых переходов:
  - new → validated
  - validated → invoice_created
  - invoice_created → paid
  - paid → shipped
  - любой → cancelled

## Генерация order_number

Формат: `ORD-YYYY-NNNN`
- YYYY - год (4 цифры)
- NNNN - порядковый номер в году (4 цифры, с ведущими нулями)

Пример: `ORD-2026-0001`, `ORD-2026-0002`

Логика:
1. Получить текущий год
2. Найти максимальный номер за год
3. Увеличить на 1
4. Сгенерировать номер с ведущими нулями

## Интеграция с AI-парсером

После успешного парсинга заказа AI-парсером:
1. Получить OrderResult от AI-парсера
2. Создать заказ через `OrderService.create_order()`
3. Статус заказа: `new` → `validated` (если все данные валидны)

## Логирование

Все операции логируются в файл `logs/crm_service.log`:
- Создание заказов
- Обновление статусов
- Ошибки валидации
- Метрики: количество созданных заказов, средний чек

## Тестирование

### Ручное тестирование
1. Создать заказ через API
2. Проверить генерацию order_number
3. Обновить статус заказа
4. Получить список заказов с фильтрами

### Тестирование транзакций
1. Создать заказ с несуществующим товаром → проверить rollback
2. Создать заказ с валидными данными → проверить commit

## Критерии готовности

- ✅ Схема БД создана и применена
- ✅ CRUD операции работают
- ✅ Статусы заказов обновляются корректно
- ✅ API endpoints возвращают правильные данные
- ✅ Валидация и обработка ошибок
- ✅ Генерация order_number работает
- ✅ Транзакции обеспечивают атомарность

## Следующие шаги

После реализации CRM перейти к Этапу 5: Доставка + Оплата для расчёта доставки и генерации счетов.
