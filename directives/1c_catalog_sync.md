# Директива: Синхронизация каталога товаров из 1С

## Цель
Синхронизировать каталог товаров из 1С:Управление нашей фирмой в локальную базу данных PostgreSQL для быстрого доступа и поиска товаров в системе SmartOrder Engine.

## Входные данные
- HTTP GET запрос к `/hs/api/get/catalog/` (1С HTTP Service)
- JSON ответ с массивом товаров

## Формат данных 1С API

### Запрос
```
GET http://{1c-server}/hs/api/get/catalog/
Headers:
  Authorization: Basic {base64(username:password)}
```

### Ответ (JSON)
```json
[
  {
    "articul": "ФР-00000044",
    "name": "Варочная панель",
    "price": 122334,
    "stock": 1
  },
  {
    "articul": "ФР-00000389",
    "name": "Шуба норковая",
    "price": 50000,
    "stock": 4
  },
  {
    "articul": "ФР-00000328",
    "name": "Пиво светлое \"Ячменный колос\" крепкое. 1,5 л",
    "price": 98,
    "stock": 1
  }
]
```

**Примечания:**
- Цены могут быть целыми числами (122334) или дробными (199.99)
- Артикулы имеют формат "ФР-XXXXXXXX" (где X - цифры)
- Названия товаров могут содержать кавычки и специальные символы

**Поля товара:**
- `articul` (string, required) - артикул товара (уникальный идентификатор)
- `name` (string, required) - наименование товара
- `price` (decimal, required) - цена товара в рублях
- `stock` (integer, required) - остаток на складе

## Выходные данные
- Таблица `products` в PostgreSQL с актуальными данными
- API endpoints для доступа к каталогу:
  - `GET /api/catalog` - список всех товаров
  - `GET /api/catalog/search?q={query}` - поиск товаров
  - `GET /api/catalog/{articul}` - товар по артикулу

## Процесс синхронизации

### Шаг 1: Получение данных из 1С
1. Выполнить HTTP GET запрос к 1С API
2. Таймаут запроса: 30 секунд
3. Retry при ошибках: 3 попытки с экспоненциальной задержкой (1s, 2s, 4s)
4. Логировать все запросы и ответы

### Шаг 2: Парсинг и валидация
1. Парсить JSON ответ
2. Валидировать структуру данных:
   - Проверить наличие обязательных полей
   - Проверить типы данных
   - Проверить, что articul не пустой
   - Проверить, что price >= 0
   - Проверить, что stock >= 0
3. Пропустить товары с некорректными данными (залогировать предупреждение)

### Шаг 3: Сохранение в БД
1. Использовать транзакцию для атомарности
2. Upsert логика:
   - Если товар с таким articul существует → обновить (name, price, stock, updated_at, synced_at)
   - Если товара нет → создать новый
3. Использовать connection pooling для производительности
4. Логировать количество обновлённых/созданных товаров

### Шаг 4: Обработка ошибок
- При ошибке сети → retry (3 попытки)
- При ошибке парсинга JSON → логировать ошибку, использовать последние успешные данные
- При ошибке БД → логировать ошибку, не прерывать процесс для других товаров
- При таймауте → retry с увеличенным таймаутом

## Крайние случаи

### Случай 1: Пустой ответ от 1С
**Симптом:** 1С вернул пустой массив `[]`  
**Действие:** 
- Логировать предупреждение
- Не очищать БД (использовать последние данные)
- Продолжить работу

### Случай 2: 1С API недоступен
**Симптом:** Connection timeout или 500/503 ошибка  
**Действие:**
- Retry 3 раза с экспоненциальной задержкой
- Если все попытки неудачны → логировать ошибку
- Использовать последние успешные данные из БД
- Не прерывать работу системы

### Случай 3: Изменилась структура ответа 1С
**Симптом:** Ошибка парсинга JSON или отсутствие ожидаемых полей  
**Действие:**
- Логировать ошибку с полным ответом для анализа
- Пропустить некорректные товары
- Обработать корректные товары
- Уведомить администратора

### Случай 4: Очень большой каталог (>100,000 товаров)
**Симптом:** Долгая синхронизация, возможен таймаут  
**Действие:**
- Использовать batch обработку (по 1000 товаров за раз)
- Использовать транзакции для каждого batch
- Логировать прогресс синхронизации

### Случай 5: Дубликаты артикулов в ответе 1С
**Симптом:** Несколько товаров с одинаковым articul  
**Действие:**
- Использовать последний товар в списке
- Логировать предупреждение о дубликатах

## Расписание синхронизации
- **Интервал:** каждые 30 минут
- **Время первого запуска:** сразу при старте системы
- **Метод:** APScheduler (встроенный планировщик в скрипте)

## Логирование

### Успешная синхронизация
```json
{
  "level": "INFO",
  "event": "catalog_sync_success",
  "timestamp": "2026-02-13T10:30:00Z",
  "products_total": 1000,
  "products_updated": 950,
  "products_created": 50,
  "duration_seconds": 12.5
}
```

### Ошибка синхронизации
```json
{
  "level": "ERROR",
  "event": "catalog_sync_error",
  "timestamp": "2026-02-13T10:30:00Z",
  "error": "Connection timeout",
  "retry_attempt": 2,
  "max_retries": 3
}
```

## Инструменты выполнения
- **execution/sync_1c_catalog.py** - основной скрипт синхронизации
- **execution/api_catalog_server.py** - FastAPI сервер для доступа к каталогу

## Переменные окружения
- `ONEC_BASE_URL` - базовый URL 1С сервера (например: `http://1c-server:port`)
- `ONEC_USERNAME` - имя пользователя для Basic Auth
- `ONEC_PASSWORD` - пароль для Basic Auth
- `DATABASE_URL` - строка подключения к PostgreSQL (например: `postgresql://user:password@localhost:5432/smartorder`)
- `REDIS_URL` - строка подключения к Redis (например: `redis://localhost:6379/0`)

## Метрики для мониторинга
- Количество товаров в каталоге
- Время последней успешной синхронизации
- Количество ошибок синхронизации за последний час
- Время выполнения синхронизации (P50, P95, P99)
- Количество обновлённых/созданных товаров за синхронизацию

## Обновления директивы
При обнаружении новых крайних случаев, изменений в API 1С или улучшений процесса - обновлять эту директиву для сохранения знаний.
