# Директива: Экспорт счетов в 1С

## Цель
Экспорт счетов на оплату в 1С:Управление нашей фирмой через HTTP Service после успешной оплаты заказа.

## Важно
- В 1С создаётся только **Счёт на оплату**, заказ не создаётся
- Счёт в 1С создаётся только **ПОСЛЕ оплаты** клиентом (при статусе "paid")
- Экспорт происходит автоматически после успешной оплаты

## Компоненты

### execution/1c_exporter.py
- Класс `OneCExporter` с методом `export_invoice(order_id)`
- Формирование данных счёта в формате 1С
- Отправка POST запроса к `/hs/invoices`
- Retry логика (3 попытки)
- Обновление флага `invoice_exported_to_1c` в БД

## Формат данных для экспорта

### Endpoint
`POST {ONEC_BASE_URL}/hs/invoices`

### Формат JSON:
```json
{
  "invoice_number": "INV-2026-001",
  "date": "2026-02-13",
  "customer": {
    "name": "Иван Иванов",
    "phone": "+79991234567",
    "address": "Москва, ул. Ленина, 1"
  },
  "items": [
    {
      "articul": "ФР-00000044",
      "name": "Варочная панель",
      "quantity": 2,
      "price": 122334,
      "total": 244668
    }
  ],
  "delivery_cost": 500,
  "total": 245168
}
```

## Аутентификация
- Basic Auth с поддержкой Unicode (base64 кодирование UTF-8)
- Заголовок: `Authorization: Basic {base64(username:password)}`

## Обработка ошибок

### Retry логика
- Максимум 3 попытки
- Задержки между попытками: 2, 5, 10 секунд
- Retry только для временных ошибок (500, 502, 503, 504)

### Dead letter queue
- Неуспешные экспорты логируются с полной информацией
- Можно добавить в Redis очередь для повторной обработки

### Логирование
- Все запросы/ответы логируются
- Структурированные логи с метаданными (order_id, invoice_number, attempt)

## Интеграция

### Автоматический экспорт
- После успешной оплаты (`payment_processor`) → автоматический вызов `OneCExporter.export_invoice()`
- Если экспорт не удался, оплата всё равно считается успешной (не критичная ошибка)

### Обновление флага
- При успешном экспорте: `invoice_exported_to_1c = True`
- При ошибке: флаг не обновляется (можно повторить экспорт)

## Переменные окружения

```env
ONEC_BASE_URL=http://1c-server:port
ONEC_USERNAME=admin
ONEC_PASSWORD=password
ONEC_INVOICES_ENDPOINT=/hs/invoices
```

## Крайние случаи

### 1. Заказ уже экспортирован
- Проверка флага `invoice_exported_to_1c`
- Если `True` → возврат информации об уже экспортированном счёте

### 2. Заказ не в статусе "paid"
- Ошибка: `Order status is '{status}', expected 'paid'`
- Экспорт возможен только после оплаты

### 3. 1С недоступен
- Retry логика (3 попытки)
- После всех попыток → ошибка, логирование
- Флаг не обновляется (можно повторить экспорт позже)

### 4. Неверный формат данных
- Валидация перед отправкой
- Логирование ошибок валидации

### 5. Таймаут запроса
- Таймаут: 60 секунд
- При таймауте → retry

## Тестирование

### Прямой вызов:
```python
from execution.1c_exporter import OneCExporter

result = OneCExporter.export_invoice(order_id)
```

### Через командную строку:
```bash
python execution/1c_exporter.py <order_id>
```

## Мониторинг

### Метрики для отслеживания:
- Количество успешных экспортов
- Количество неуспешных экспортов
- Время экспорта (P95, P99)
- Количество retry попыток

### Логи для анализа:
- `logs/1c_exporter.log` - все операции экспорта
- Структурированные логи с метаданными

## Обновление директивы

При обнаружении проблем или улучшений:
1. Обновить эту директиву
2. Обновить код в `execution/1c_exporter.py`
3. Протестировать изменения
4. Обновить документацию в `docs/Step-by-Step Guide.md` при необходимости
