2026-02-14 23:49:42,679 - __main__ - INFO - Starting Queue Processor...
2026-02-14 23:49:42,679 - __main__ - INFO - Worker concurrency: 5
2026-02-14 23:49:42,681 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-14 23:49:42,681 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-14 23:49:42,681 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-14 23:49:42,682 - __main__ - INFO - Starting 5 workers...
2026-02-14 23:49:42,758 - __main__ - INFO - Worker 1 started
2026-02-14 23:49:42,760 - __main__ - INFO - Worker 2 started
2026-02-14 23:49:42,762 - __main__ - INFO - Worker 3 started
2026-02-14 23:49:42,762 - __main__ - INFO - Worker 4 started
2026-02-14 23:49:42,765 - __main__ - INFO - Worker 5 started
2026-02-14 23:49:42,795 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 34
2026-02-14 23:49:42,795 - __main__ - INFO - Calling AI Parser for channel: yandex_mail, message_id: None
2026-02-14 23:49:42,910 - __main__ - INFO - Successfully processed message from telegram
2026-02-14 23:49:42,910 - __main__ - INFO - Successfully processed message from yandex_mail
2026-02-15 00:03:35,794 - __main__ - INFO - Starting Queue Processor...
2026-02-15 00:03:35,796 - __main__ - INFO - Worker concurrency: 5
2026-02-15 00:03:35,796 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 00:03:35,796 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 00:03:35,797 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 00:03:35,797 - __main__ - INFO - Starting 5 workers...
2026-02-15 00:03:35,862 - __main__ - INFO - Worker 1 started
2026-02-15 00:03:35,864 - __main__ - INFO - Worker 2 started
2026-02-15 00:03:35,865 - __main__ - INFO - Worker 3 started
2026-02-15 00:03:35,866 - __main__ - INFO - Worker 4 started
2026-02-15 00:03:35,867 - __main__ - INFO - Worker 5 started
2026-02-15 00:06:41,849 - __main__ - INFO - Starting Queue Processor...
2026-02-15 00:06:41,850 - __main__ - INFO - Worker concurrency: 5
2026-02-15 00:06:41,850 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 00:06:41,850 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 00:06:41,851 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 00:06:41,851 - __main__ - INFO - Starting 5 workers...
2026-02-15 00:06:41,904 - __main__ - INFO - Worker 1 started
2026-02-15 00:06:41,906 - __main__ - INFO - Worker 2 started
2026-02-15 00:06:41,906 - __main__ - INFO - Worker 3 started
2026-02-15 00:06:41,907 - __main__ - INFO - Worker 4 started
2026-02-15 00:06:41,907 - __main__ - INFO - Worker 5 started
2026-02-15 00:06:41,926 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,928 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,932 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,932 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,933 - __main__ - WARNING - Message 40 returned to queue (retry 1/3)
2026-02-15 00:06:41,934 - __main__ - WARNING - Message 40 returned to queue (retry 1/3)
2026-02-15 00:06:41,935 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,935 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,937 - __main__ - WARNING - Message 40 returned to queue (retry 1/3)
2026-02-15 00:06:41,938 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,938 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,940 - __main__ - WARNING - Message 40 returned to queue (retry 1/3)
2026-02-15 00:06:41,941 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,941 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,942 - __main__ - WARNING - Message 40 returned to queue (retry 1/3)
2026-02-15 00:06:41,943 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,944 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,945 - __main__ - WARNING - Message 40 returned to queue (retry 2/3)
2026-02-15 00:06:41,946 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,947 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,950 - __main__ - WARNING - Message 40 returned to queue (retry 2/3)
2026-02-15 00:06:41,951 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,952 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,954 - __main__ - WARNING - Message 40 returned to queue (retry 2/3)
2026-02-15 00:06:41,954 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,955 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,957 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,957 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,958 - __main__ - WARNING - Message 40 returned to queue (retry 2/3)
2026-02-15 00:06:41,959 - __main__ - WARNING - Message 40 returned to queue (retry 2/3)
2026-02-15 00:06:41,960 - __main__ - ERROR - Error calling AI Parser: No module named 'execution'
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 121, in call_ai_parser
    from execution.ai_order_parser import process_order_message
ModuleNotFoundError: No module named 'execution'
2026-02-15 00:06:41,961 - __main__ - ERROR - Failed to process message from telegram
2026-02-15 00:06:41,963 - __main__ - ERROR - Message sent to dead letter queue: Failed after 3 retries
2026-02-15 00:10:25,466 - __main__ - INFO - Starting Queue Processor...
2026-02-15 00:10:25,466 - __main__ - INFO - Worker concurrency: 5
2026-02-15 00:10:25,466 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 00:10:25,466 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 00:10:25,466 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 00:10:25,466 - __main__ - INFO - Starting 5 workers...
2026-02-15 00:10:25,514 - __main__ - INFO - Worker 1 started
2026-02-15 00:10:25,516 - __main__ - INFO - Worker 2 started
2026-02-15 00:10:25,516 - __main__ - INFO - Worker 3 started
2026-02-15 00:10:25,517 - __main__ - INFO - Worker 4 started
2026-02-15 00:10:25,518 - __main__ - INFO - Worker 5 started
2026-02-15 00:12:10,286 - __main__ - INFO - Starting Queue Processor...
2026-02-15 00:12:10,287 - __main__ - INFO - Worker concurrency: 5
2026-02-15 00:12:10,287 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 00:12:10,287 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 00:12:10,287 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 00:12:10,287 - __main__ - INFO - Starting 5 workers...
2026-02-15 00:12:10,335 - __main__ - INFO - Worker 1 started
2026-02-15 00:12:10,336 - __main__ - INFO - Worker 2 started
2026-02-15 00:12:10,337 - __main__ - INFO - Worker 3 started
2026-02-15 00:12:10,337 - __main__ - INFO - Worker 4 started
2026-02-15 00:12:10,338 - __main__ - INFO - Worker 5 started
2026-02-15 00:12:10,966 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 42
2026-02-15 00:12:10,996 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 00:12:11,002 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 00:12:11,271 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 00:12:13,726 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 00:12:13,729 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 00:12:13,729 - execution.ai_order_parser - INFO - Order parsed: status=needs_clarification, products=1, missing_data=4
2026-02-15 00:12:13,730 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 00:12:13,730 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:02:44,409 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:02:44,410 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:02:44,410 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:02:44,410 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:02:44,410 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:02:44,410 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:02:44,472 - __main__ - INFO - Worker 1 started
2026-02-15 01:02:44,473 - __main__ - INFO - Worker 2 started
2026-02-15 01:02:44,475 - __main__ - INFO - Worker 3 started
2026-02-15 01:02:44,476 - __main__ - INFO - Worker 4 started
2026-02-15 01:02:44,477 - __main__ - INFO - Worker 5 started
2026-02-15 01:03:48,675 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 44
2026-02-15 01:03:48,709 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:03:48,716 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:03:48,991 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:03:51,751 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:03:51,756 - execution.ai_order_parser - INFO - OpenAI API response received: 283 characters
2026-02-15 01:03:51,756 - execution.ai_order_parser - INFO - Order parsed: status=needs_clarification, products=1, missing_data=0
2026-02-15 01:03:51,756 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:03:51,757 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:07:37,994 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 46
2026-02-15 01:07:38,278 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:07:41,136 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:07:41,138 - execution.ai_order_parser - INFO - OpenAI API response received: 283 characters
2026-02-15 01:07:41,139 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:07:41,139 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:07:41,288 - execution.crm_service - INFO - Database connection pool initialized
2026-02-15 01:07:41,298 - execution.crm_service - INFO - Generated order number: ORD-2026-0000
2026-02-15 01:07:41,308 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:07:41,309 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:07:41,309 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:07:41,316 - execution.crm_service - INFO - Order created: ORD-2026-0000 (ID: 87d5c3af-3a1f-4af1-942c-b33ba935eadf)
2026-02-15 01:07:41,317 - __main__ - INFO - Order saved to database: ORD-2026-0000 (ID: 87d5c3af-3a1f-4af1-942c-b33ba935eadf)
2026-02-15 01:07:41,592 - execution.invoice_generator - INFO - Invoice PDF generated: .tmp\invoices\87d5c3af-3a1f-4af1-942c-b33ba935eadf.pdf (invoice: INV-2026-8861)
2026-02-15 01:07:41,594 - execution.crm_service - INFO - Order 87d5c3af-3a1f-4af1-942c-b33ba935eadf status updated: validated -> invoice_created
2026-02-15 01:07:41,731 - execution.invoice_generator - INFO - Order 87d5c3af-3a1f-4af1-942c-b33ba935eadf status updated to invoice_created
2026-02-15 01:07:41,731 - execution.invoice_generator - INFO - Invoice generated: INV-2026-8861 for order ORD-2026-0000
2026-02-15 01:07:41,731 - __main__ - INFO - Invoice generated: INV-2026-8861 for order ORD-2026-0000
2026-02-15 01:07:41,731 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:17:00,196 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:17:00,196 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:17:00,197 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:17:00,197 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:17:00,197 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:17:00,197 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:17:00,250 - __main__ - INFO - Worker 1 started
2026-02-15 01:17:00,252 - __main__ - INFO - Worker 2 started
2026-02-15 01:17:00,253 - __main__ - INFO - Worker 3 started
2026-02-15 01:17:00,254 - __main__ - INFO - Worker 4 started
2026-02-15 01:17:00,254 - __main__ - INFO - Worker 5 started
2026-02-15 01:17:16,323 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 48
2026-02-15 01:17:16,354 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:17:16,361 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:17:16,649 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:17:19,152 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:17:19,155 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:17:19,156 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:17:19,156 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:17:19,298 - execution.crm_service - INFO - Database connection pool initialized
2026-02-15 01:17:19,308 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:17:19,313 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:17:19,314 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:17:19,314 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:17:19,322 - execution.crm_service - ERROR - Error creating order: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 211, in create_order
    cursor.execute("""
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.

2026-02-15 01:17:19,323 - __main__ - ERROR - Failed to save order to database: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 205, in process_message
    order = OrderService.create_order(order_data)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 211, in create_order
    cursor.execute("""
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.

2026-02-15 01:17:19,325 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:24:47,441 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:24:47,441 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:24:47,442 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:24:47,442 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:24:47,442 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:24:47,443 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:24:47,503 - __main__ - INFO - Worker 1 started
2026-02-15 01:24:47,506 - __main__ - INFO - Worker 2 started
2026-02-15 01:24:47,507 - __main__ - INFO - Worker 3 started
2026-02-15 01:24:47,508 - __main__ - INFO - Worker 4 started
2026-02-15 01:24:47,509 - __main__ - INFO - Worker 5 started
2026-02-15 01:24:59,599 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 50
2026-02-15 01:24:59,627 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:24:59,633 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:24:59,942 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:25:02,166 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:25:02,168 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:25:02,168 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:25:02,169 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:25:02,178 - __main__ - ERROR - Failed to save order to database: expected 'except' or 'finally' block (crm_service.py, line 185)
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 183, in process_message
    from execution.crm_service import OrderService
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 185
    delivery_cost = order_data.get("delivery_cost", 0)
    ^^^^^^^^^^^^^
SyntaxError: expected 'except' or 'finally' block
2026-02-15 01:25:02,180 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:27:47,915 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:27:47,916 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:27:47,916 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:27:47,916 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:27:47,916 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:27:47,916 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:27:47,969 - __main__ - INFO - Worker 1 started
2026-02-15 01:27:47,970 - __main__ - INFO - Worker 2 started
2026-02-15 01:27:47,971 - __main__ - INFO - Worker 3 started
2026-02-15 01:27:47,972 - __main__ - INFO - Worker 4 started
2026-02-15 01:27:47,975 - __main__ - INFO - Worker 5 started
2026-02-15 01:27:55,839 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 52
2026-02-15 01:27:55,870 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:27:55,878 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:27:56,155 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:27:59,904 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:27:59,908 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:27:59,909 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:27:59,909 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:27:59,914 - __main__ - ERROR - Failed to save order to database: expected 'except' or 'finally' block (crm_service.py, line 299)
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 183, in process_message
    from execution.crm_service import OrderService
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 299
    except psycopg2_errors.UniqueViolation as e:
SyntaxError: expected 'except' or 'finally' block
2026-02-15 01:27:59,914 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:29:15,455 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:29:15,456 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:29:15,456 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:29:15,456 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:29:15,456 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:29:15,456 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:29:15,504 - __main__ - INFO - Worker 1 started
2026-02-15 01:29:15,506 - __main__ - INFO - Worker 2 started
2026-02-15 01:29:15,508 - __main__ - INFO - Worker 3 started
2026-02-15 01:29:15,511 - __main__ - INFO - Worker 4 started
2026-02-15 01:29:15,512 - __main__ - INFO - Worker 5 started
2026-02-15 01:29:21,235 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 54
2026-02-15 01:29:21,266 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:29:21,276 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:29:21,569 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:29:24,433 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:29:24,434 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:29:24,435 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:29:24,435 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:29:24,483 - execution.crm_service - INFO - Database connection pool initialized
2026-02-15 01:29:24,495 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:29:24,501 - execution.crm_service - WARNING - Failed to calculate delivery cost: DeliveryCalculator.calculate_for_order() takes 2 positional arguments but 3 were given, using 0
2026-02-15 01:29:24,503 - __main__ - ERROR - Failed to save order to database: name 'psycopg2_errors' is not defined
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 218, in create_order
    cursor.execute("""
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.


During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 205, in process_message
    order = OrderService.create_order(order_data)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 299, in create_order
    except psycopg2_errors.UniqueViolation as e:
           ^^^^^^^^^^^^^^^
NameError: name 'psycopg2_errors' is not defined
2026-02-15 01:29:24,511 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:30:27,932 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:30:27,932 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:30:27,932 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:30:27,932 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:30:27,932 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:30:27,932 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:30:27,983 - __main__ - INFO - Worker 1 started
2026-02-15 01:30:27,985 - __main__ - INFO - Worker 2 started
2026-02-15 01:30:27,986 - __main__ - INFO - Worker 3 started
2026-02-15 01:30:27,987 - __main__ - INFO - Worker 4 started
2026-02-15 01:30:27,988 - __main__ - INFO - Worker 5 started
2026-02-15 01:30:36,781 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 56
2026-02-15 01:30:36,812 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:30:36,818 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:30:37,117 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:30:39,528 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:30:39,532 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:30:39,533 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:30:39,533 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:30:39,590 - execution.crm_service - INFO - Database connection pool initialized
2026-02-15 01:30:39,595 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:30:39,602 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:30:39,602 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:30:39,602 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:30:39,604 - execution.crm_service - WARNING - Duplicate order number detected, retrying (1/3)...
2026-02-15 01:30:39,705 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:30:39,705 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:30:39,705 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:30:39,705 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:30:39,708 - execution.crm_service - WARNING - Duplicate order number detected, retrying (2/3)...
2026-02-15 01:30:39,908 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:30:39,921 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:30:39,923 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:30:39,925 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:30:39,926 - execution.crm_service - ERROR - Error creating order: duplicate order number after 3 retries: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.

2026-02-15 01:30:39,961 - __main__ - ERROR - Failed to save order to database: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.
Traceback (most recent call last):
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\queue_processor.py", line 205, in process_message
    order = OrderService.create_order(order_data)
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\reg-81_new\Desktop\Sinchro_Yandex\reg-81_new\AI_Works_Tasks\SmartOrder Engine\execution\crm_service.py", line 216, in create_order
    cursor.execute("""
psycopg2.errors.UniqueViolation: duplicate key value violates unique constraint "orders_order_number_key"
DETAIL:  Key (order_number)=(ORD-2026-0001) already exists.

2026-02-15 01:30:39,973 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 01:32:45,273 - __main__ - INFO - Starting Queue Processor...
2026-02-15 01:32:45,273 - __main__ - INFO - Worker concurrency: 5
2026-02-15 01:32:45,274 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 01:32:45,274 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 01:32:45,274 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 01:32:45,274 - __main__ - INFO - Starting 5 workers...
2026-02-15 01:32:45,321 - __main__ - INFO - Worker 1 started
2026-02-15 01:32:45,323 - __main__ - INFO - Worker 2 started
2026-02-15 01:32:45,324 - __main__ - INFO - Worker 3 started
2026-02-15 01:32:45,325 - __main__ - INFO - Worker 4 started
2026-02-15 01:32:45,326 - __main__ - INFO - Worker 5 started
2026-02-15 01:32:51,664 - __main__ - INFO - Calling AI Parser for channel: telegram, message_id: 58
2026-02-15 01:32:51,696 - execution.ai_order_parser - INFO - Database connection pool initialized
2026-02-15 01:32:51,702 - execution.ai_order_parser - INFO - Loaded 143 products from database
2026-02-15 01:32:52,108 - execution.ai_order_parser - INFO - OpenAI client initialized: model=gpt-4.1-mini, base_url=https://api.proxyapi.ru/openai/v1
2026-02-15 01:32:54,354 - httpx - INFO - HTTP Request: POST https://api.proxyapi.ru/openai/v1/chat/completions "HTTP/1.1 200 OK"
2026-02-15 01:32:54,359 - execution.ai_order_parser - INFO - OpenAI API response received: 288 characters
2026-02-15 01:32:54,359 - execution.ai_order_parser - INFO - Order parsed: status=validated, products=1, missing_data=0
2026-02-15 01:32:54,360 - __main__ - INFO - AI Parser successfully processed message from telegram
2026-02-15 01:32:54,426 - execution.crm_service - INFO - Database connection pool initialized
2026-02-15 01:32:54,431 - execution.crm_service - INFO - Generated order number: ORD-2026-0001
2026-02-15 01:32:54,438 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:32:54,438 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:32:54,439 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:32:54,442 - execution.crm_service - WARNING - Duplicate order number detected, retrying (1/3)...
2026-02-15 01:32:54,543 - execution.crm_service - INFO - Generated order number: ORD-2026-0002
2026-02-15 01:32:54,543 - execution.delivery_calculator - INFO - DeliveryCalculator initialized
2026-02-15 01:32:54,544 - execution.delivery_calculator - INFO - Delivery calculated: Москва ул. Ленина д.1 (1.0 kg) -> 500 RUB, 1 days
2026-02-15 01:32:54,544 - execution.crm_service - INFO - Delivery cost calculated: 500 RUB for Москва ул. Ленина д.1
2026-02-15 01:32:54,551 - execution.crm_service - INFO - Order created: ORD-2026-0002 (ID: e9ce4db3-7df1-423d-8b93-893707d9530b)
2026-02-15 01:32:54,552 - __main__ - INFO - Order saved to database: ORD-2026-0002 (ID: e9ce4db3-7df1-423d-8b93-893707d9530b)
2026-02-15 01:32:54,773 - execution.invoice_generator - INFO - Registered Cyrillic font: C:/Windows/Fonts/arial.ttf
2026-02-15 01:32:54,811 - execution.invoice_generator - INFO - Registered Cyrillic bold font: C:/Windows/Fonts/arialbd.ttf
2026-02-15 01:32:54,881 - execution.invoice_generator - INFO - Invoice PDF generated: .tmp\invoices\e9ce4db3-7df1-423d-8b93-893707d9530b.pdf (invoice: INV-2026-0374)
2026-02-15 01:32:54,885 - execution.crm_service - INFO - Order e9ce4db3-7df1-423d-8b93-893707d9530b status updated: validated -> invoice_created
2026-02-15 01:32:55,030 - execution.invoice_generator - INFO - Order e9ce4db3-7df1-423d-8b93-893707d9530b status updated to invoice_created
2026-02-15 01:32:55,031 - execution.invoice_generator - INFO - Invoice generated: INV-2026-0374 for order ORD-2026-0002
2026-02-15 01:32:55,031 - __main__ - INFO - Invoice generated: INV-2026-0374 for order ORD-2026-0002
2026-02-15 01:32:55,031 - __main__ - INFO - Successfully processed message from telegram
2026-02-15 08:04:50,105 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:04:50,107 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:04:50,107 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:04:50,107 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:04:50,107 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:04:50,107 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:04:50,140 - __main__ - INFO - Worker 1 started
2026-02-15 08:04:50,150 - __main__ - INFO - Worker 2 started
2026-02-15 08:04:50,151 - __main__ - INFO - Worker 3 started
2026-02-15 08:04:50,152 - __main__ - INFO - Worker 4 started
2026-02-15 08:04:50,153 - __main__ - INFO - Worker 5 started
2026-02-15 08:09:07,993 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:09:07,993 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:09:07,993 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:09:07,993 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:09:07,993 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:09:07,993 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:09:08,029 - __main__ - INFO - Worker 1 started
2026-02-15 08:09:08,029 - __main__ - INFO - Worker 2 started
2026-02-15 08:09:08,029 - __main__ - INFO - Worker 3 started
2026-02-15 08:09:08,029 - __main__ - INFO - Worker 4 started
2026-02-15 08:09:08,034 - __main__ - INFO - Worker 5 started
2026-02-15 08:33:29,780 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:33:29,784 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:33:29,784 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:33:29,784 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:33:29,784 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:33:29,784 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:33:29,811 - __main__ - INFO - Worker 1 started
2026-02-15 08:33:29,815 - __main__ - INFO - Worker 2 started
2026-02-15 08:33:29,815 - __main__ - INFO - Worker 3 started
2026-02-15 08:33:29,815 - __main__ - INFO - Worker 4 started
2026-02-15 08:33:29,815 - __main__ - INFO - Worker 5 started
2026-02-15 08:38:10,778 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:38:10,778 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:38:10,778 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:38:10,778 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:38:10,779 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:38:10,779 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:38:10,819 - __main__ - INFO - Worker 1 started
2026-02-15 08:38:10,821 - __main__ - INFO - Worker 2 started
2026-02-15 08:38:10,822 - __main__ - INFO - Worker 3 started
2026-02-15 08:38:10,822 - __main__ - INFO - Worker 4 started
2026-02-15 08:38:10,823 - __main__ - INFO - Worker 5 started
2026-02-15 08:43:46,401 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:43:46,401 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:43:46,401 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:43:46,401 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:43:46,401 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:43:46,401 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:43:46,434 - __main__ - INFO - Worker 1 started
2026-02-15 08:43:46,434 - __main__ - INFO - Worker 2 started
2026-02-15 08:43:46,434 - __main__ - INFO - Worker 3 started
2026-02-15 08:43:46,434 - __main__ - INFO - Worker 4 started
2026-02-15 08:43:46,434 - __main__ - INFO - Worker 5 started
2026-02-15 08:56:28,196 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:56:28,196 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:56:28,196 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:56:28,196 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:56:28,196 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:56:28,197 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:56:28,243 - __main__ - INFO - Worker 1 started
2026-02-15 08:56:28,243 - __main__ - INFO - Worker 2 started
2026-02-15 08:56:28,243 - __main__ - INFO - Worker 3 started
2026-02-15 08:56:28,243 - __main__ - INFO - Worker 4 started
2026-02-15 08:56:28,243 - __main__ - INFO - Worker 5 started
2026-02-15 08:59:26,627 - __main__ - INFO - Starting Queue Processor...
2026-02-15 08:59:26,631 - __main__ - INFO - Worker concurrency: 5
2026-02-15 08:59:26,631 - __main__ - INFO - Redis URL: redis://localhost:6379/0
2026-02-15 08:59:26,631 - __main__ - INFO - AI Parser URL: http://localhost:8001
2026-02-15 08:59:26,631 - __main__ - INFO - Health check: http://0.0.0.0:8027/health
2026-02-15 08:59:26,631 - __main__ - INFO - Starting 5 workers...
2026-02-15 08:59:26,672 - __main__ - INFO - Worker 1 started
2026-02-15 08:59:26,672 - __main__ - INFO - Worker 2 started
2026-02-15 08:59:26,672 - __main__ - INFO - Worker 3 started
2026-02-15 08:59:26,672 - __main__ - INFO - Worker 4 started
2026-02-15 08:59:26,672 - __main__ - INFO - Worker 5 started
