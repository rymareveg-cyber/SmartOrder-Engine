# Критерии приёмки: SmartOrder Engine

## 1. Общая информация

**Версия документа**: v1.0  
**Дата**: 13.02.2026

Данный документ содержит детальные критерии приёмки для каждого этапа разработки. Каждый критерий должен быть выполнен для того, чтобы этап считался завершённым.

---

## 2. Этап 1: Синхронизация каталога 1С

### 2.1. Функциональные критерии
- ✅ Скрипт синхронизации работает и обновляет БД
- ✅ Автоматический запуск каждые 30 минут настроен и работает
- ✅ API endpoint `/catalog` возвращает актуальные данные
- ✅ Поиск по каталогу работает быстро (индексы созданы)
- ✅ Обработка ошибок и логирование реализованы

### 2.2. Технические критерии
- ✅ Синхронизация обрабатывает до 100,000 товаров
- ✅ Таймаут запроса к 1С: 30 секунд
- ✅ При ошибке синхронизации используются последние успешные данные
- ✅ Все ошибки логируются в структурированном формате

### 2.3. Критерии производительности
- ✅ Время синхронизации каталога: ≤ 5 минут для 10,000 товаров
- ✅ Время ответа API `/catalog`: P95 ≤ 500ms

---

## 3. Этап 2: Омниканальный приём заказов

### 3.1. Telegram Bot
- ✅ Telegram бот принимает сообщения и отправляет в очередь
- ✅ Бот поддерживает команды: `/start`, `/help`, `/status`
- ✅ Бот использует inline клавиатуры для подтверждения
- ✅ Бот отправляет уточняющие вопросы клиенту
- ✅ Бот отправляет счета и трек-номера

### 3.2. Яндекс.Почта IMAP
- ✅ IMAP парсер мониторит почту каждые 2 минуты
- ✅ Парсер обрабатывает письма с заказами
- ✅ Парсер извлекает вложения (если есть)
- ✅ Система отправляет ответные письма с уточнениями
- ✅ Письма попадают в единую очередь

### 3.3. Яндекс.Формы Webhook
- ✅ Webhook принимает POST запросы от Яндекс.Форм
- ✅ Данные формы валидируются
- ✅ Данные трансформируются в единый формат
- ✅ Данные попадают в единую очередь

### 3.4. Единая очередь
- ✅ Все каналы отправляют данные в единую очередь (Redis Queue)
- ✅ Формат сообщения в очереди единый для всех каналов
- ✅ Queue Processor обрабатывает сообщения из очереди асинхронно
- ✅ Обработка ошибок и retry логика реализованы

### 3.5. Ограничения
- ✅ Максимальный размер сообщения: 10,000 символов (валидация)
- ✅ Максимальный размер вложения: 5 MB (валидация)
- ✅ Таймаут обработки сообщения: 5 минут

---

## 4. Этап 3: AI-парсинг

### 4.1. Извлечение данных
- ✅ AI-парсер извлекает товары из неструктурированного текста
- ✅ Сопоставление с каталогом работает (fuzzy matching)
- ✅ Извлекается количество каждого товара
- ✅ Извлекаются контактные данные: ФИО, телефон, адрес
- ✅ Определяются недостающие данные

### 4.2. Валидация
- ✅ Проверяется существование товара в каталоге
- ✅ Проверяется достаточность остатка
- ✅ Валидируется формат телефона
- ✅ Валидируется адрес доставки

### 4.3. Уточнения
- ✅ Генерируются уточняющие вопросы при недостатке данных
- ✅ Вопросы отправляются в тот же канал, откуда пришёл заказ
- ✅ Обрабатываются ответы на уточняющие вопросы

### 4.4. Обработка ошибок
- ✅ Обработка ошибок и fallback механизмы реализованы
- ✅ Fallback на правила (regex) при недоступности AI API
- ✅ Все ошибки логируются

### 4.5. Критерии качества
- ✅ Точность AI-парсинга: ≥ 90%
- ✅ Таймаут ответа AI-сервиса: 30 секунд
- ✅ Максимальное количество уточняющих вопросов: 3

---

## 5. Этап 4: CRM Postgres

### 5.1. База данных
- ✅ Схема БД создана и применена
- ✅ Все необходимые таблицы созданы: `products`, `orders`, `order_items`, `order_status_history`
- ✅ Все необходимые индексы созданы
- ✅ Миграции БД работают корректно

### 5.2. CRUD операции
- ✅ CRUD операции для заказов работают
- ✅ Создание заказа с уникальным номером
- ✅ Чтение заказа по номеру
- ✅ Обновление заказа
- ✅ Удаление заказа (soft delete)

### 5.3. Статусы заказов
- ✅ Статусы заказов обновляются корректно:
  - `new` - новый заказ
  - `validated` - валидирован AI-парсером
  - `invoice_created` - счёт создан
  - `paid` - оплачен
  - `shipped` - отправлен
  - `cancelled` - отменён
- ✅ Автоматическое обновление статусов работает
- ✅ Ручное изменение статусов (для менеджера) работает
- ✅ История изменений статусов сохраняется

### 5.4. API endpoints
- ✅ API endpoints возвращают правильные данные
- ✅ API поддерживает фильтрацию по статусу, каналу, дате
- ✅ API поддерживает поиск по номеру заказа, ФИО, телефону
- ✅ API поддерживает пагинацию
- ✅ API возвращает данные в формате JSON
- ✅ Валидация и обработка ошибок реализованы

### 5.5. Производительность
- ✅ Время ответа API: P95 ≤ 500ms, P99 ≤ 1s
- ✅ Фильтрация и поиск работают быстро (индексы)

---

## 6. Этап 5: Доставка и Оплата

### 6.1. Расчёт доставки
- ✅ Расчёт доставки работает для разных городов
- ✅ Расчёт веса заказа на основе товаров
- ✅ Возвращается срок доставки
- ✅ Правила расчёта конфигурируемые

### 6.2. Генерация счетов
- ✅ PDF счёты генерируются в стиле 1С
- ✅ Счёт содержит: реквизиты компании, данные клиента, таблицу товаров, итоговую сумму
- ✅ Счёт имеет уникальный номер (INV-YYYY-NNNN)
- ✅ Счёт отправляется клиенту (Telegram/Email)
- ✅ Размер PDF счёта: ≤ 5 MB

### 6.3. Обработка оплаты
- ✅ Оплата обрабатывается (fake система)
- ✅ Валидируется формат данных карты
- ✅ Симулируется успешная оплата
- ✅ Статус заказа обновляется на "paid" после оплаты
- ✅ Данные карт не логируются (только последние 4 цифры)

### 6.4. Генерация трек-номеров
- ✅ Трек-номера генерируются после оплаты
- ✅ Формат трек-номера: TRACK-YYYYMMDD-XXXXXX
- ✅ Статус обновляется на "shipped"
- ✅ Трек-номер отправляется клиенту

### 6.5. Ограничения
- ✅ Максимальный вес для доставки: 50 кг (валидация)
- ✅ Максимальная стоимость доставки: 10,000₽ (валидация)

---

## 7. Этап 6: Экспорт в 1С

### 7.1. Экспорт счетов
- ✅ Экспорт счетов в 1С работает (при статусе "paid", ПОСЛЕ оплаты)
- ✅ Формат данных соответствует API 1С
- ✅ Обрабатывается ответ 1С
- ✅ Флаг invoice_exported_to_1c обновляется

### 7.2. Обработка ошибок
- ✅ Обработка ошибок и retry логика реализованы
- ✅ Повтор экспорта при ошибке (3 попытки)
- ✅ Неуспешные экспорты помещаются в dead letter queue
- ✅ Все попытки экспорта логируются

### 7.4. Ограничения
- ✅ Таймаут запроса к 1С: 60 секунд
- ✅ Максимальное количество товаров в экспорте: 100
- ✅ Интервал между повторными попытками: 5 минут

---

## 8. Этап 7: Dashboard

### 8.1. Просмотр заказов
- ✅ Dashboard отображает список всех заказов
- ✅ Фильтрация по статусу, каналу, дате работает
- ✅ Поиск по номеру заказа, ФИО, телефону работает
- ✅ Детальная информация о заказе отображается
- ✅ Пагинация работает
- ✅ Максимальное количество заказов на странице: 100

### 8.2. Управление заказами
- ✅ Изменение статуса заказа вручную работает
- ✅ История изменений статусов отображается
- ✅ Просмотр PDF счета работает

### 8.3. Статистика
- ✅ Статистика рассчитывается корректно:
  - Выручка (сегодня, неделя, месяц)
  - Количество заказов
  - Конверсия (новые → оплаченные)
  - Средний чек
  - Топ товаров
- ✅ Статистика обновляется в реальном времени
- ✅ Время обновления статистики: ≤ 5 секунд

### 8.4. Каталог
- ✅ Каталог товаров с остатками отображается
- ✅ Остатки обновляются в реальном времени (live sync)
- ✅ Статус синхронизации с 1С показывается

### 8.5. Совместимость
- ✅ Поддержка браузеров: Chrome, Firefox, Safari (последние 2 версии)
- ✅ Dashboard интуитивно понятен
- ✅ Ошибки отображаются в понятном формате

---

## 9. Общие критерии приёмки

### 9.1. Функциональность
- ✅ Все функциональные требования реализованы
- ✅ Все компоненты протестированы
- ✅ Нет критических багов

### 9.2. Производительность
- ✅ Производительность соответствует требованиям:
  - Время ответа API: P95 ≤ 500ms, P99 ≤ 1s
  - Время обработки заказа: ≤ 2 минуты
  - Пропускная способность: ≥ 100 заказов/минуту

### 9.3. Надёжность
- ✅ Доступность системы: ≥ 99.5%
- ✅ Время восстановления после сбоя: ≤ 5 минут
- ✅ Обработка ошибок реализована
- ✅ Retry логика для всех внешних API работает

### 9.4. Безопасность
- ✅ Все API endpoints защищены аутентификацией
- ✅ Пароли и токены хранятся в переменных окружения
- ✅ Данные карт не логируются
- ✅ Rate limiting для публичных API работает

### 9.5. Документация
- ✅ Документация актуальна
- ✅ API документация создана
- ✅ README с инструкциями по установке и запуску

### 9.6. Логирование
- ✅ Логирование работает корректно
- ✅ Логи структурированы (JSON формат)
- ✅ Все ошибки логируются

---

## 10. Процесс приёмки

### 10.1. Для каждого этапа
1. Разработчик отмечает выполненные критерии
2. Code review проверяет соответствие критериям
3. QA тестирует функциональность
4. Менеджер проекта проверяет выполнение всех критериев
5. Этап считается завершённым после выполнения всех критериев

### 10.2. Финальная приёмка
1. Все этапы завершены
2. Все общие критерии выполнены
3. Нагрузочное тестирование пройдено
4. Документация актуальна
5. Система готова к production

---

**Конец документа**
