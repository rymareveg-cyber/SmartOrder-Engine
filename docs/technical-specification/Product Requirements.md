# Техническое задание: SmartOrder Engine

## 1. Общая информация

### 1.1. Наименование проекта
**SmartOrder Engine** - AI-система автоматической обработки заказов в e-commerce с интеграцией 1С:Управление нашей фирмой

### 1.2. Версия документа
**v1.0** от 13.02.2026

### 1.3. Описание проекта
Создание интеллектуальной системы для автоматического приёма, обработки и управления заказами из различных каналов связи с использованием AI для понимания запросов на естественном языке и автоматической интеграцией с 1С:Управление нашей фирмой.

Система обеспечивает:
- Автоматический приём заказов из нескольких каналов (Telegram, Яндекс.Почта, Яндекс.Формы)
- Интеллектуальную обработку неструктурированных запросов с помощью AI
- Автоматическую синхронизацию с системой учёта 1С
- Полный жизненный цикл заказа от получения до отправки

---

## 2. Целевая аудитория и бизнес-проблемы

### 2.1. Целевая аудитория

#### 2.1.1. Менеджеры по продажам
**Роль**: Основные пользователи системы, обрабатывающие заказы

**Проблемы (боли)**:
- **Ручная обработка заказов**: Трата 15-30 минут на каждый заказ из-за необходимости вручную парсить сообщения, искать товары в каталоге, проверять остатки
- **Множественные каналы связи**: Заказы приходят из разных источников (Telegram, Email, Формы), что усложняет отслеживание и обработку
- **Ошибки при оформлении**: Человеческий фактор приводит к ошибкам в количестве товаров, адресах доставки, контактных данных
- **Несинхронизированные данные**: Необходимость вручную проверять остатки в 1С, что занимает время и может привести к продаже отсутствующих товаров
- **Монотонная работа**: Большая часть времени уходит на рутинные операции вместо работы с клиентами

**Выгоды от системы**:
- Автоматическая обработка заказов за 2 минуты вместо 15-30
- Единый интерфейс для всех каналов связи
- Снижение ошибок на 80%
- Освобождение времени для работы с клиентами и развития продаж

#### 2.1.2. Клиенты (покупатели)
**Роль**: Конечные пользователи, размещающие заказы

**Проблемы (боли)**:
- **Долгое ожидание ответа**: Менеджеры не всегда могут быстро обработать заказ, особенно в нерабочее время
- **Необходимость структурировать заказ**: Клиенты должны точно указывать артикулы, количества, что неудобно при заказе через мессенджеры
- **Отсутствие информации о статусе**: Клиенты не знают, обработан ли их заказ, создан ли счёт, отправлен ли товар
- **Ошибки в заказах**: Из-за человеческого фактора могут быть ошибки в количестве или наименовании товаров

**Выгоды от системы**:
- Быстрая обработка заказов (до 2 минут)
- Возможность заказать товары простым текстом на естественном языке
- Автоматические уведомления о статусе заказа
- Снижение ошибок при оформлении

#### 2.1.3. Администраторы/Владельцы бизнеса
**Роль**: Управление бизнес-процессами и контроль работы системы

**Проблемы (боли)**:
- **Высокие операционные расходы**: Необходимость содержать большой штат менеджеров для обработки заказов
- **Масштабирование**: С ростом количества заказов требуется увеличение штата, что увеличивает затраты
- **Отсутствие аналитики**: Сложно отслеживать эффективность работы, конверсию, популярные товары
- **Двойной учёт**: Необходимость вручную переносить данные из мессенджеров/почты в 1С
- **Потеря заказов**: Заказы могут быть пропущены или обработаны с задержкой

**Выгоды от системы**:
- Увеличение пропускной способности в 5 раз без увеличения штата
- Автоматизация 90% рутинных операций
- Автоматическая синхронизация с 1С, исключающая двойной учёт
- Статистика и аналитика в реальном времени
- Снижение операционных расходов

### 2.2. Бизнес-цели

- Сокращение времени обработки заказа с 15-30 минут до 2 минут
- Увеличение количества обрабатываемых заказов в 5 раз без увеличения штата
- Снижение ошибок при оформлении заказов на 80%
- Автоматизация 90% рутинных операций менеджеров
- Повышение удовлетворённости клиентов за счёт быстрой обработки заказов

---

## 3. Функциональные требования

### 3.1. Синхронизация каталога 1С

#### 3.1.1. Функциональность
- **FR-1.1**: Система должна синхронизировать каталог товаров из 1С:Управление нашей фирмой через HTTP Service
- **FR-1.2**: Синхронизация должна выполняться автоматически каждые 30 минут
- **FR-1.3**: Система должна хранить в БД: артикул, наименование, цену, остаток
- **FR-1.4**: Система должна предоставлять API endpoint `/catalog` для доступа к каталогу
- **FR-1.5**: Система должна поддерживать поиск товаров по названию и артикулу

#### 3.1.2. Входные данные
- HTTP GET запрос к `/hs/catalog/products` (1С HTTP Service)
- JSON ответ с массивом товаров

#### 3.1.3. Выходные данные
- Таблица `products` в PostgreSQL с актуальными данными
- API endpoints для доступа к каталогу

#### 3.1.4. Ограничения
- Максимальный размер каталога: 100,000 товаров
- Таймаут запроса к 1С: 30 секунд
- При ошибке синхронизации использовать последние успешные данные

### 3.2. Омниканальный приём заказов

#### 3.2.1. Telegram Bot
- **FR-2.1**: Бот должен принимать текстовые сообщения с заказами
- **FR-2.2**: Бот должен отправлять уточняющие вопросы клиенту
- **FR-2.3**: Бот должен отправлять счета и трек-номера
- **FR-2.4**: Бот должен поддерживать команды: `/start`, `/help`, `/status`
- **FR-2.5**: Бот должен использовать inline клавиатуры для подтверждения

#### 3.2.2. Яндекс.Почта IMAP
- **FR-2.6**: Система должна мониторить входящие письма каждые 2 минуты
- **FR-2.7**: Система должна парсить текст писем с заказами
- **FR-2.8**: Система должна извлекать вложения (если есть)
- **FR-2.9**: Система должна отправлять ответные письма с уточнениями

#### 3.2.3. Яндекс.Формы Webhook
- **FR-2.10**: Система должна принимать POST запросы от Яндекс.Форм
- **FR-2.11**: Система должна валидировать данные формы
- **FR-2.12**: Система должна трансформировать данные в единый формат

#### 3.2.4. Единая очередь
- **FR-2.13**: Все заказы из всех каналов должны попадать в единую очередь обработки
- **FR-2.14**: Формат сообщения в очереди должен быть единым для всех каналов
- **FR-2.15**: Система должна обрабатывать сообщения из очереди асинхронно

#### 3.2.5. Ограничения
- Максимальный размер сообщения: 10,000 символов
- Максимальный размер вложения: 5 MB
- Таймаут обработки сообщения: 5 минут

### 3.3. AI-парсинг заказов

#### 3.3.1. Извлечение данных
- **FR-3.1**: Система должна извлекать товары из неструктурированного текста
- **FR-3.2**: Система должна сопоставлять товары с каталогом 1С (fuzzy matching)
- **FR-3.3**: Система должна извлекать количество каждого товара
- **FR-3.4**: Система должна извлекать контактные данные: ФИО, телефон, адрес
- **FR-3.5**: Система должна определять недостающие данные

#### 3.3.2. Валидация
- **FR-3.6**: Система должна проверять существование товара в каталоге
- **FR-3.7**: Система должна проверять достаточность остатка
- **FR-3.8**: Система должна валидировать формат телефона
- **FR-3.9**: Система должна валидировать адрес доставки

#### 3.3.3. Уточнения
- **FR-3.10**: Система должна генерировать уточняющие вопросы при недостатке данных
- **FR-3.11**: Система должна отправлять вопросы в тот же канал, откуда пришёл заказ
- **FR-3.12**: Система должна обрабатывать ответы на уточняющие вопросы

#### 3.3.4. Ограничения
- Максимальное количество товаров в одном заказе: 50
- Максимальное количество уточняющих вопросов: 3
- Таймаут ответа AI-сервиса: 30 секунд
- Fallback на правила (regex) при недоступности AI-сервиса

### 3.4. CRM и управление заказами

#### 3.4.1. Управление заказами
- **FR-4.1**: Система должна создавать заказы в БД с уникальным номером
- **FR-4.2**: Система должна хранить полную информацию о заказе и клиенте
- **FR-4.3**: Система должна поддерживать CRUD операции для заказов
- **FR-4.4**: Система должна хранить товары заказа со ссылкой на каталог 1С
- **FR-4.5**: Система должна сохранять цену товара на момент заказа (snapshot)

#### 3.4.2. Статусы заказа
- **FR-4.6**: Система должна поддерживать статусы:
  - `new` - новый заказ
  - `validated` - валидирован AI-парсером
  - `invoice_created` - счёт создан
  - `paid` - оплачен
  - `shipped` - отправлен
  - `cancelled` - отменён
- **FR-4.7**: Система должна автоматически обновлять статусы
- **FR-4.8**: Система должна позволять ручное изменение статусов (для менеджера)

#### 3.4.3. API для заказов
- **FR-4.9**: Система должна предоставлять REST API для работы с заказами
- **FR-4.10**: API должен поддерживать фильтрацию, поиск, пагинацию
- **FR-4.11**: API должен возвращать данные в формате JSON

#### 3.4.4. Ограничения
- Максимальный размер заказа: 1 MB (JSON)
- Максимальное количество товаров в заказе: 100
- История изменений статусов: последние 100 изменений

### 3.5. Доставка и Оплата

#### 3.5.1. Расчёт доставки
- **FR-5.1**: Система должна рассчитывать стоимость доставки на основе города и веса
- **FR-5.2**: Система должна рассчитывать вес заказа на основе товаров
- **FR-5.3**: Система должна возвращать срок доставки
- **FR-5.4**: Правила расчёта должны быть конфигурируемыми

#### 3.5.2. Генерация счетов
- **FR-5.5**: Система должна генерировать PDF счёт в стиле 1С
- **FR-5.6**: Счёт должен содержать: реквизиты компании, данные клиента, таблицу товаров, итоговую сумму
- **FR-5.7**: Счёт должен иметь уникальный номер (INV-YYYY-NNNN)
- **FR-5.8**: Система должна отправлять счёт клиенту (Telegram/Email)

#### 3.5.3. Обработка оплаты
- **FR-5.9**: Система должна принимать данные карты (fake система)
- **FR-5.10**: Система должна валидировать формат данных карты
- **FR-5.11**: Система должна симулировать успешную оплату
- **FR-5.12**: Система должна обновлять статус заказа на "paid" после оплаты

#### 3.5.4. Генерация трек-номеров
- **FR-5.13**: Система должна генерировать трек-номер после оплаты
- **FR-5.14**: Формат трек-номера: TRACK-YYYYMMDD-XXXXXX
- **FR-5.15**: Система должна обновлять статус на "shipped" и отправлять трек-номер клиенту

#### 3.5.5. Ограничения
- Максимальный вес для доставки: 50 кг
- Максимальная стоимость доставки: 10,000₽
- Размер PDF счёта: ≤ 5 MB

### 3.6. Экспорт в 1С

#### 3.6.1. Экспорт счетов
- **FR-6.1**: Система должна экспортировать счёт в 1С при статусе "paid" (ПОСЛЕ оплаты клиентом)
- **FR-6.2**: Формат данных должен соответствовать API 1С
- **FR-6.3**: Система должна обрабатывать ответ 1С
- **FR-6.4**: Система должна помечать счёт как экспортированный (флаг invoice_exported_to_1c)
- **FR-6.5**: PDF счёт создаётся локально при статусе "invoice_created" (до оплаты, не экспортируется в 1С)

#### 3.6.2. Обработка ошибок
- **FR-6.9**: Система должна повторять экспорт при ошибке (3 попытки)
- **FR-6.10**: Система должна помещать неуспешные экспорты в dead letter queue
- **FR-6.11**: Система должна логировать все попытки экспорта

#### 3.6.4. Ограничения
- Таймаут запроса к 1С: 60 секунд
- Максимальное количество товаров в экспорте: 100
- Интервал между повторными попытками: 5 минут

### 3.7. Dashboard для менеджера

#### 3.7.1. Просмотр заказов
- **FR-7.1**: Dashboard должен отображать список всех заказов
- **FR-7.2**: Dashboard должен поддерживать фильтрацию по статусу, каналу, дате
- **FR-7.3**: Dashboard должен поддерживать поиск по номеру заказа, ФИО, телефону
- **FR-7.4**: Dashboard должен отображать детальную информацию о заказе
- **FR-7.5**: Dashboard должен поддерживать пагинацию

#### 3.7.2. Управление заказами
- **FR-7.6**: Dashboard должен позволять изменять статус заказа вручную
- **FR-7.7**: Dashboard должен отображать историю изменений статусов
- **FR-7.8**: Dashboard должен позволять просматривать PDF счета

#### 3.7.3. Статистика
- **FR-7.9**: Dashboard должен отображать статистику:
  - Выручка (сегодня, неделя, месяц)
  - Количество заказов
  - Конверсия (новые → оплаченные)
  - Средний чек
  - Топ товаров
- **FR-7.10**: Статистика должна обновляться в реальном времени

#### 3.7.4. Каталог
- **FR-7.11**: Dashboard должен отображать каталог товаров с остатками
- **FR-7.12**: Остатки должны обновляться в реальном времени (live sync)
- **FR-7.13**: Dashboard должен показывать статус синхронизации с 1С

#### 3.7.5. Ограничения
- Максимальное количество заказов на странице: 100
- Время обновления статистики: ≤ 5 секунд
- Поддержка браузеров: Chrome, Firefox, Safari (последние 2 версии)

---

## 4. Нефункциональные требования

### 4.1. Производительность
- **NFR-1**: Время ответа API: P95 ≤ 500ms, P99 ≤ 1s
- **NFR-2**: Пропускная способность: ≥ 100 заказов/минуту
- **NFR-3**: Время обработки заказа: ≤ 2 минуты (от получения до создания в CRM)
- **NFR-4**: Время синхронизации каталога: ≤ 5 минут для 10,000 товаров

### 4.2. Надёжность
- **NFR-5**: Доступность системы: ≥ 99.5% (uptime)
- **NFR-6**: Время восстановления после сбоя: ≤ 5 минут
- **NFR-7**: Обработка ошибок: все ошибки должны логироваться и обрабатываться
- **NFR-8**: Retry логика для всех внешних API (3 попытки с экспоненциальной задержкой)

### 4.3. Масштабируемость
- **NFR-9**: Система должна поддерживать до 1,000,000 товаров в каталоге
- **NFR-10**: Система должна обрабатывать до 10,000 заказов в день
- **NFR-11**: Система должна поддерживать горизонтальное масштабирование

### 4.4. Безопасность
- **NFR-12**: Все API endpoints должны быть защищены аутентификацией (JWT или API key)
- **NFR-13**: Пароли и токены должны храниться в переменных окружения (.env)
- **NFR-14**: Данные карт не должны логироваться (только последние 4 цифры)
- **NFR-15**: Все HTTP запросы должны использовать HTTPS в production
- **NFR-16**: Rate limiting для всех публичных API endpoints

### 4.5. Совместимость
- **NFR-17**: Python 3.11+
- **NFR-18**: PostgreSQL 14+
- **NFR-19**: Redis 7+ (или другая система очередей)
- **NFR-20**: Совместимость с 1С:Управление нашей фирмой 8.3+

### 4.6. Удобство использования
- **NFR-21**: Dashboard должен быть интуитивно понятным
- **NFR-22**: Все сообщения бота должны быть на русском языке
- **NFR-23**: Ошибки должны отображаться в понятном формате

---

## 5. Технические требования

### 5.1. Общие требования к архитектуре
- Система должна быть модульной и расширяемой
- Компоненты должны быть слабо связаны (loose coupling)
- Система должна поддерживать асинхронную обработку задач
- Должна быть реализована обработка ошибок и retry логика

### 5.2. Технологические требования

#### Backend
- **Язык программирования**: Python 3.11+
- **Фреймворк**: Современный асинхронный веб-фреймворк
- **База данных**: Реляционная БД (PostgreSQL 14+ или совместимая)
- **Очередь задач**: Система очередей для асинхронной обработки
- **AI-сервис**: API для обработки естественного языка
- **PDF генерация**: Библиотека для генерации PDF документов
- **HTTP клиент**: Библиотека для работы с HTTP запросами

#### Frontend (Dashboard)
- Современный веб-фреймворк или библиотека для создания интерфейса
- Поддержка REST API для взаимодействия с backend

#### Инфраструктура
- Контейнеризация (опционально)
- Структурированное логирование

### 5.3. База данных

#### Требуемые таблицы
- `products` - каталог товаров из 1С
- `orders` - заказы
- `order_items` - товары в заказе
- `order_status_history` - история изменений статусов (опционально)

#### Требуемые индексы
- Уникальный индекс на артикул товара
- Индекс на название товара (для поиска)
- Уникальный индекс на номер заказа
- Индексы на статус, дату создания, телефон клиента (для фильтрации и поиска)

### 5.4. Интеграции

#### Внешние API
- **1С HTTP Service**: синхронизация каталога, экспорт счетов (после оплаты)
- **AI API**: для парсинга заказов
- **Telegram Bot API**: приём и отправка сообщений
- **Яндекс.Почта IMAP**: мониторинг почты
- **Яндекс.Формы Webhook**: приём данных форм

---

## 6. Ограничения и исключения

### 6.1. Функциональные ограничения
- Система не обрабатывает возвраты товаров (out of scope)
- Система не интегрируется с реальными платёжными системами (только fake карта)
- Система не поддерживает мультивалютность (только рубли)
- Система не поддерживает скидки и промокоды (на первом этапе)
- Система не поддерживает частичную оплату заказа

### 6.2. Технические ограничения
- Максимальный размер каталога: 100,000 товаров
- Максимальное количество товаров в заказе: 100
- Максимальный размер сообщения: 10,000 символов
- Максимальный размер вложения: 5 MB
- Таймаут запроса к 1С: 60 секунд
- Таймаут запроса к AI-сервису: 30 секунд

### 6.3. Исключения из scope
- Мобильное приложение (не входит в scope)
- Интеграция с другими CRM системами (только 1С)
- Расширенная система аналитики и отчётов (базовая статистика в Dashboard)
- Многоязычность (только русский язык)
- Интеграция с системами доставки (расчёт локальный)

---

## 7. Риски и митигация

### 7.1. Технические риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Недоступность 1С API | Средняя | Высокое | Кэширование данных, fallback на последние данные |
| Недоступность AI API | Средняя | Высокое | Fallback на правила (regex), retry логика |
| Перегрузка системы очередей | Низкая | Среднее | Мониторинг, горизонтальное масштабирование |
| Ошибки в AI-парсинге | Средняя | Среднее | Валидация результатов, уточняющие вопросы |
| Потеря данных | Низкая | Критическое | Регулярные бэкапы БД, транзакции |

### 7.2. Бизнес-риски

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Изменение требований | Высокая | Среднее | Гибкая архитектура, модульность |
| Недостаточная производительность | Средняя | Среднее | Профилирование, оптимизация, масштабирование |
| Проблемы с интеграцией 1С | Средняя | Высокое | Тесное взаимодействие с командой 1С, тестирование |

---

## 8. Измеримые KPI

| KPI | Целевое значение | Метрика измерения |
|-----|------------------|-------------------|
| **Время обработки заказа** | ≤ 2 минуты | От получения сообщения до создания заказа в CRM |
| **Точность AI-парсинга** | ≥ 90% | Процент корректно извлечённых товаров и данных |
| **Доступность системы** | ≥ 99.5% | Uptime системы (исключая плановые обновления) |
| **Синхронизация каталога** | ≤ 30 минут | Максимальная задержка обновления остатков |
| **Конверсия заказов** | ≥ 70% | От новых заказов до оплаченных |
| **Время ответа API** | ≤ 500ms | P95 latency для всех API endpoints |
| **Обработка ошибок** | ≤ 1% | Процент заказов, требующих ручного вмешательства |

---

## 9. Глоссарий

- **1С HTTP Service** - веб-сервис 1С:Управление нашей фирмой для интеграции
- **AI-парсинг** - извлечение структурированных данных из неструктурированного текста с помощью AI
- **Fuzzy matching** - нечёткое сопоставление (поиск похожих строк)
- **Dead letter queue** - очередь для сообщений, которые не удалось обработать
- **Snapshot** - снимок данных на определённый момент времени (цена товара на момент заказа)
- **Upsert** - операция обновления существующей записи или создания новой, если её нет

---

**Конец документа**
